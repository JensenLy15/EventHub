<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <body>
    <!-- Fragment expects: Map "profile" -->
    <div th:fragment="editForm(profile)">
      <h2 style="margin-top: 0">Edit Profile</h2>
      <form
        th:action="@{/profile/edit}"
        method="post"
        th:fragment="editForm"
        style="display: grid; gap: 0.75rem"
      >
        <input
          th:if="${_csrf != null}"
          type="hidden"
          th:name="${_csrf.parameterName}"
          th:value="${_csrf.token}"
        />

        <label>
          Display name
          <input
            type="text"
            name="displayName"
            th:value="${profile['display_name']}"
            placeholder="Your display name"
          />
        </label>

        <label>
          Avatar URL
          <input
            type="url"
            name="avatarUrl"
            th:value="${profile['avatar_url']}"
            placeholder="https://example.com/avatar.png"
          />
        </label>

        <label>
          Bio
          <textarea
            name="bio"
            rows="4"
            placeholder="Tell us about yourself"
            th:text="${profile['bio']}"
          ></textarea>
        </label>

        <label style="display: flex; align-items: center; justify-content: space-between;">
          <span>Select up to 3 preferred categories:</span>
          <button 
              type="submit" 
              name="resetCategories" 
              class="btn btn-secondary btn-sm"
              onclick="return confirm('Are you sure you want to reset your preferred categories?');">
              Reset
          </button>
        </label>

        <div id="preferredCategories" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
          <div th:each="cat : ${allCategories}">
            <label style="display: flex; align-items: center; gap: 0.25rem;">
              <input
                type="checkbox"
                name="categoryIds"
                th:value="${cat.categoryId}"
                th:checked="${preferredCategoryIds.contains(cat.categoryId)}" />
              <span th:text="${cat.name}"></span>
            </label>
          </div>
        </div>

        <!--Prevents user to select more than 3 preferred categories-->
        <script>
          document.addEventListener("DOMContentLoaded", function() {
            const maxCategories = 3;
            const checkboxes = document.querySelectorAll('#preferredCategories input[type="checkbox"]');

            checkboxes.forEach(checkbox => {
              checkbox.addEventListener('change', () => {
                const checkedCount = document.querySelectorAll('#preferredCategories input[type="checkbox"]:checked').length;
                if (checkedCount > maxCategories) {
                  alert(`You can select up to ${maxCategories} categories only.`);
                  checkbox.checked = false; // undo last check
                }
              });
            });
          });
        </script>
        
        <!--Reset preferred categories confirmation message-->
        <script>
            document.getElementById('resetCategoriesForm').addEventListener('submit', function(event) {
                const confirmed = confirm("Are you sure you want to reset your preferred categories?");
                if (!confirmed) {
                    event.preventDefault(); 
                }
            });
        </script>

        
        <label>
          Gender
          <select
            name="gender"
            th:value="${profile['gender'] != null ? profile['gender'] : 'prefer_not_to_say'}"
          >
            <option value="male" th:selected="${profile['gender'] == 'male'}">
              Male
            </option>
            <option
              value="female"
              th:selected="${profile['gender'] == 'female'}"
            >
              Female
            </option>
            <option
              value="nonbinary"
              th:selected="${profile['gender'] == 'nonbinary'}"
            >
              Non-binary
            </option>
            <option value="other" th:selected="${profile['gender'] == 'other'}">
              Other
            </option>
            <option
              value="prefer_not_to_say"
              th:selected="${profile['gender'] == null || profile['gender'] == 'prefer_not_to_say'}"
            >
              Prefer not to say
            </option>
          </select>
        </label>

        <div
          style="
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            margin-top: 0.5rem;
          "
        >
          <button type="button" class="btn" onclick="closeProfileModal()">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Save changes</button>
        </div>
      </form>
    </div>
  </body>
</html>
